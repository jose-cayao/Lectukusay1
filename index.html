<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectukusay</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables para colores */
        :root {
            --primary-color: #00376e;
            --secondary-color: #129cec;
            --accent-color: #f32f19;
            --success-color: #fca503;
            --bg-color: #f7f8fa;
            --text-color: #070707;
            --card-bg: #ffffff;
            --border-color: #03376b;
            /* Modo Oscuro */
            --background-dark: #2c3e50; /* Azul oscuro */
            --text-dark: #ecf0f1; /* Gris claro */
            --card-background-dark: #34495e; /* Azul oscuro m√°s claro */

            /* Niveles de puntaje actualizados */
            --level-c-color: #e74c3c; /* Rojo para Inicio */
            --level-b-color: #f39c12; /* Amarillo para Proceso */
            --level-a-color: #ff8c00; /* Anaranjado para Logrado */
            --level-ad-color: #27ae60; /* Verde para Logro Destacado */
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 20;
            padding: 20;
            background: var(--background-light); /* Aplicar el degradado al fondo */
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            color: var(--text-color);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        /* Modo oscuro */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        body.dark-mode header {
            background-color: var(--card-background-dark);
            color: var(--text-dark);
        }

        body.dark-mode .sidebar {
            background-color: var(--card-background-dark);
            color: var(--text-dark);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        body.dark-mode .student-form input,
        body.dark-mode .controls select {
            background-color: var(--card-background-dark);
            color: var(--text-dark);
            border: 1px solid white;
        }

        /* Botones en modo oscuro tambi√©n amarillos */
        body.dark-mode .student-form button,
        body.dark-mode .btn-primary,
        body.dark-mode .btn-secondary,
        body.dark-mode .controls button,
        body.dark-mode .visual-options button {
            background-color: var(--secondary-color);
            color: white; /* Asegurar texto blanco en botones amarillos */
            border: 1px solid var(--secondary-color); /* Borde amarillo en modo oscuro */
        }
        body.dark-mode .student-form button:hover,
        body.dark-mode .btn-primary:hover,
        body.dark-mode .btn-secondary:hover,
        body.dark-mode .controls button:hover,
        body.dark-mode .visual-options button:hover {
            background-color: #e0a027; /* Amarillo m√°s oscuro al pasar el rat√≥n en modo oscuro */
        }


        body.dark-mode .text-display,
        body.dark-mode .quiz-section,
        body.dark-mode .comment-section {
            background-color: var(--card-background-dark);
            color: var(--text-dark);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: rgb(253, 253, 253);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.966);
        }

        header h1 {
            margin: 0;
            font-size: 5.8rem;
            display: inline-block; /* Permitir que h1 se siente al lado de la imagen */
            vertical-align: middle; /* Alinear con la imagen */
            margin-right: 15px; /* Espacio entre el t√≠tulo y el slogan */
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        #logo {
            vertical-align: middle;
            margin-right: 75px;
            border-radius: 10%;
            max-width: 150px; /* Tama√±o m√°ximo del logo */
            height: auto;
        }

        #logo1 {
            vertical-align: middle;
            margin-right: 05px;
            border-radius: 10%;
            max-width: 400px; /* Tama√±o m√°ximo del logo */
            height: auto;
        }
        .slogan-container {
            margin-top: 0.1rem; /* Espacio entre el t√≠tulo y el slogan */
            width: 100%; /* Ocupar todo el ancho para el marquee */
        }

        .slogan-container p {
            margin: 0; /* Eliminar m√°rgenes predeterminados del p√°rrafo dentro del marquee */
            font-size: 0.2rem;
        }

        main {
            display: flex;
            flex: 1;
            padding: 1.5rem;
            gap: 1.5rem;
        }

        .sidebar {
            flex: 0 0 280px; /* Ancho fijo para la barra lateral */
            background-color: #b8d4f0;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(5, 1, 250, 0.979);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* T√≠tulos en el sidebar y secciones de contenido */
        .sidebar h2, .sidebar h3,
        .text-display h2,
        .quiz-section h2, .comment-section h2,
        .visual-options h3 {
            color: #2b85df;; /* Color negro para los t√≠tulos */
            margin-top: 0;
            border-bottom: 2px solid var(--primary-color); /* Borde con color primario */
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Estilo para los contenedores de input con bot√≥n de voz */
        .input-with-speech {
            display: flex;
            align-items: center;
            gap: 5px; /* Peque√±o espacio entre input y bot√≥n */
            margin-bottom: 0.8rem; /* Mantener margen original para el grupo */
        }

        .input-with-speech input {
            flex-grow: 1; /* Permitir que el input ocupe el espacio disponible */
            margin-bottom: 0; /* Eliminar margen individual ya que est√° en el div padre */
            width: auto; /* Ancho autom√°tico para que flex-grow funcione */
            padding: 0.8rem;
            border-radius: 8px; /* Bordes m√°s redondeados */
            border: 2px solid var(--primary-color); /* Borde m√°s visible */
            font-size: 1rem;
            box-sizing: border-box; /* Incluir padding y border en el ancho/alto */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sombra sutil */
        }

        .input-with-speech input:focus {
            border-color: var(--secondary-color); /* Borde amarillo al enfocar */
            box-shadow: 0 0 8px rgba(247, 179, 43, 0.7); /* Sombra m√°s pronunciada al enfocar */
            outline: none; /* Eliminar el contorno por defecto */
        }

        /* Estilo para todos los botones */
        .student-form button, .btn-primary, .btn-secondary, .text-actions button, .visual-options button {
            background-color: var(--primary-color); /* Botones en azul */
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
            padding: 0.8rem 1.2rem; /* Padding consistente */
            border-radius: 10px; /* Bordes m√°s redondeados */
            font-size: 1rem;
        }

        .student-form button:hover, .btn-primary:hover, .btn-secondary:hover, .text-actions button:hover, .visual-options button:hover {
            background-color: #3a6a9a; /* Azul m√°s oscuro al pasar el rat√≥n */
        }

        /* Estilo espec√≠fico para los botones de dictado de voz */
        .speech-input-btn {
            background-color: var(--primary-color); /* Usar color primario (azul acero) para botones de micr√≥fono */
            color: white;
            border: none;
            border-radius: 10px; /* Bordes m√°s redondeados */
            padding: 0.5rem 0.7rem; /* Padding m√°s peque√±o */
            cursor: pointer;
            font-size: 1.2rem; /* Hacer el icono del micr√≥fono un poco m√°s grande */
            transition: background-color 0.3s ease;
            flex-shrink: 0; /* Evitar que el bot√≥n se encoja */
        }

        .speech-input-btn:hover {
            background-color: #3a6a9a; /* Azul acero m√°s oscuro al pasar el rat√≥n */
        }

        /* Modo oscuro para los botones de dictado de voz */
        body.dark-mode .speech-input-btn {
            background-color: var(--primary-color); /* Azul en modo oscuro */
            color: var(--text-dark); /* Texto oscuro para contraste */
        }
        body.dark-mode .speech-input-btn:hover {
            background-color: #3a6a9a; /* Azul m√°s oscuro al pasar el rat√≥n */
        }

        .student-info p {
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        #levelAchieved {
            font-weight: bold;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            display: inline-block;
        }

        .level-c { background-color: var(--level-c-color); color: white; }
        .level-b { background-color: var(--level-b-color); color: white; }
        .level-a { background-color: var(--level-a-color); color: white; }
        .level-ad { background-color: var(--level-ad-color); color: white; }

        .reading-record ul, .ranking ol {
            list-style: none;
            padding: 0;
        }

        .reading-record li, .ranking li {
            padding: 0.5rem 0;
            border-bottom: 1px dashed #eee;
            display: flex; /* Para alinear el texto y el bot√≥n de borrar */
            justify-content: space-between;
            align-items: center;
        }

        .ranking li .delete-student-btn {
            background: none;
            border: none;
            color: #e74c3c; /* Rojo para el icono de borrar */
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s ease;
            padding: 0.2rem;
        }

        .ranking li .delete-student-btn:hover {
            color: #c0392b; /* Rojo m√°s oscuro al pasar el rat√≥n */
        }


        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-background-light);
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgb(18, 1, 243);
            flex-wrap: wrap;
            gap: 1rem;
            background-color: #b1c8df;
        }

        .controls select {
            padding: 0.8rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 1rem;
            background-color: white;
            cursor: pointer;
        }

        .text-actions button {
            margin-left: 0.5rem; /* Mantener margen entre botones de acci√≥n de texto */
        }

        .text-display, .quiz-section, .comment-section {
            background-color: var(--card-background-light);
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgb(55, 0, 252);
            min-height: 300px; /* Para asegurar un tama√±o m√≠nimo */
        }

        .text-display .author {
            color: #111010;
            font-style: italic;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        #textContent { /* Aplicar el tama√±o de fuente directamente aqu√≠ */
            line-height: 1.8;
            margin-bottom: 1rem;
            font-size: 1.1rem; /* Tama√±o de texto inicial */
        }

        #textContent p { /* Eliminar font-size de aqu√≠ para que el del padre funcione */
            margin-bottom: 1rem;
        }

        .placeholder-text {
            text-align: center;
            color: #888;
            padding: 50px;
            font-style: italic;
        }

        .reading-message {
            background-color: var(--accent-color);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            font-size: 1.3rem;
            font-weight: bold;
            margin-top: 1rem;
        }

        .question {
            margin-bottom: 1.5rem;
            border-bottom: 1px dashed #eee;
            padding-bottom: 1rem;
        }

        .question p {
            font-weight: bold;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }

        /* Estilo para inputs de respuesta corta y labels de radio */
        .question .short-answer-input {
            width: 100%; /* Ocupar todo el ancho disponible */
            padding: 0.8rem;
            border: 1px solid var(--primary-color); /* Borde con color primario */
            border-radius: 8px; /* Bordes m√°s redondeados */
            font-size: 1rem;
            box-sizing: border-box; /* Incluir padding y border en el ancho/alto */
            margin-top: 0.5rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .question .short-answer-input:focus {
            border-color: var(--secondary-color); /* Borde amarillo al enfocar */
            box-shadow: 0 0 5px rgba(247, 179, 43, 0.5); /* Sombra amarilla al enfocar */
            outline: none; /* Eliminar el contorno por defecto */
        }

        .question label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.6rem; /* A√±adir padding para mejor √°rea de clic */
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .question label:hover {
            background-color: #f0f0f0; /* Fondo sutil al pasar el rat√≥n */
        }
        body.dark-mode .question label:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .quiz-feedback {
            margin-top: 1rem;
            font-weight: bold;
        }

        /* Comment Section */
        .comment-input-area {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .comment-input-area textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            margin-bottom: 0; /* Eliminar margen individual */
            box-sizing: border-box; /* Incluir padding y border en el ancho/alto */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-mode .comment-input-area textarea {
            background-color: var(--card-background-dark);
            color: var(--text-dark);
            border: 1px solid var(--accent-color);
        }
        .comment-input-area textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 5px rgba(247, 179, 43, 0.5);
            outline: none;
        }

        /* New Visual Options Section */
        .visual-options {
            margin-bottom: 1.5rem; /* Espacio debajo de esta secci√≥n */
            padding-bottom: 1rem;
            border-bottom: 1px dashed #dddbe4; /* Separador */
        }

        footer {
             background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-align: center;
            padding: 0px;
            border-radius: 7px;
            margin: 0px;
        }

        /* Media Queries para Responsividad */
        @media (max-width: 1024px) {
            main {
                flex-direction: column;
            }

            .sidebar {
                flex: none;
                width: 100%;
            }

            .controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .text-actions {
                margin-top: 1rem;
            }

            .text-actions button {
                margin-left: 0;
                margin-right: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            main {
                padding: 1rem;
            }

            .sidebar, .text-display, .quiz-section, .comment-section, .controls {
                padding: 1rem;
            }

            .text-display h2 {
                font-size: 1.8rem;
            }

            #textContent {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: 1.5rem;
            }

            .student-form input, .student-form button,
            .controls select, .text-actions button {
                font-size: 0.9rem;
                padding: 0.6rem;
            }

            .text-display h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <img id="logo" src="https://i.pinimg.com/736x/ed/5c/99/ed5c999a1162251cf4efd18c4b09a1cc.jpg">
         <b><h1>LectuKusuy</h1></b>
        <div class="slogan-container">
            <!-- Nota: La etiqueta <marquee> est√° obsoleta y puede no ser compatible en futuros navegadores. -->
            <b><marquee behavior="scroll" direction="left" scrollamount="5"><p>¬°La alegr√≠a de leer comienza aqu√≠!</p></marquee></b>
        </div>
    </header>

    <main>
        <aside class="sidebar">
            <div class="visual-options"> <!-- Nueva secci√≥n para opciones visuales, ahora al inicio del sidebar -->
                <h3>Opciones de Visualizaci√≥n</h3>
                <button id="toggleThemeBtn">üåô Modo Oscuro / ‚òÄÔ∏è Modo Claro</button>
            </div>
            <h2>Panel de Estudiante</h2>
            <div class="student-form">
                <h3>Ingresa tus datos:</h3>
                <div class="input-with-speech">
                    <input type="text" id="studentName" placeholder="Nombre(s) y Apellido(s)">
                    <button class="speech-input-btn" data-target="studentName" title="Dictar nombre">üé§</button>
                </div>
                <div class="input-with-speech">
                    <input type="text" id="studentGrade" placeholder="Grado">
                    <button class="speech-input-btn" data-target="studentGrade" title="Dictar grado">üé§</button>
                </div>
                <button id="activateStudent">Activar</button>
            </div>
            <div class="student-info"> <!-- Removed style="display:none;" -->
                <p>¬°Bienvenido(a), <span id="currentStudentName"></span>!</p>
                <p>Grado: <span id="currentStudentGrade"></span></p>
                <p>Puntaje Total: <span id="totalScore">0</span></p>
                <p>Nivel Alcanzado: <span id="levelAchieved" class="level-c">Inicio (C)</span></p>
                <button id="registerNewStudentBtn" class="btn-secondary" style="margin-top: 1rem;">Registrar Nuevo Estudiante</button>
            </div>
            <div class="reading-record">
                <h3>Record de Lectura:</h3>
                <ul id="readTextsList">
                    <!-- Textos le√≠dos se a√±adir√°n aqu√≠ -->
                </ul>
            </div>
            <div class="ranking">
                <h3>Ranking:</h3>
                <ol id="studentRanking">
                    <!-- El ranking de estudiantes se cargar√° aqu√≠ -->
                </ol>
            </div>
        </aside>

        <section class="content-area">
            <nav class="controls">
                <div class="text-selector">
                    <label for="textCategory">Elige tu aventura:</label>
                    <select id="textCategory">
                        <option value="cuentos">Cuentos</option>
                        <option value="novelas">Novelas</option>
                        <option value="fabulas">F√°bulas</option>
                        <option value="articulos">Art√≠culos Informativos</option>
                    </select>
                </div>
                <div class="text-actions">
                    <!-- Un solo bot√≥n para Leer/Pausar/Reanudar -->
                    <button id="readAloudBtn">üó£Ô∏è Leer en Voz Alta</button>
                    <button id="increaseFontSizeBtn">A+</button>
                    <button id="decreaseFontSizeBtn">A-</button>
                </div>
            </nav>

            <article class="text-display">
                <h2 id="textTitle"></h2>
                <div id="textAuthor" class="author"></div>
                <div id="textContent">
                    <p class="placeholder-text">Selecciona una categor√≠a de texto y luego un texto para empezar a leer. ¬°La aventura te espera!</p>
                </div>
                <button id="startQuizBtn" class="btn-primary" style="display:none;">Termin√© de leer, ¬°a la comprensi√≥n!</button>
            </article>

            <section id="readingMessage" class="reading-message" style="display:none;">
                <p>¬°Bien hecho! Has terminado esta lectura. üéâ</p>
            </section>

            <section id="quizSection" class="quiz-section" style="display:none;">
                <h2>Preguntas de Comprensi√≥n</h2>
                <div id="quizQuestions">
                    <!-- Preguntas del quiz se cargar√°n aqu√≠ -->
                </div>
                <button id="submitQuizBtn" class="btn-primary">Enviar Respuestas</button>
                <button id="retryQuizBtn" class="btn-secondary" style="display:none;">Intentar de Nuevo</button>
                <p id="quizFeedback"></p>
            </section>

            <section id="commentSection" class="comment-section" style="display:none;">
                <h2>Tu Reflexi√≥n sobre el Texto</h2>
                <p>¬øQu√© te pareci√≥ la lectura? ¬øQu√© ideas o sentimientos te gener√≥? ¬°Comparte tus pensamientos!</p>
                <div class="comment-input-area">
                    <textarea id="textComment" placeholder="Escribe aqu√≠ tu comentario..."></textarea>
                    <button class="speech-input-btn" data-target="textComment" title="Dictar comentario">üé§</button>
                </div>
                <button id="submitCommentBtn" class="btn-primary">Enviar Comentario</button>
                <p id="commentFeedback" style="margin-top: 1rem; font-weight: bold;"></p>
            </section>
        </section>
    </main>

    <footer>
            <p>¬© 2025 LectuMundo - Plataforma Educativa Interactiva</p>
            <p>¬© 2025 Jos√© Lenis Cayao Bustamante</p>
            <p>Desarrollado para fomentar la lectura y comprensi√≥n en estudiantes de secundaria</p>
    </footer>

    <script>
        // --- Data de Textos (JSON embebido) ---
        const cuentosData = [
            {
                "title": "El Principito",
                "author": "Antoine de Saint-Exup√©ry",
                "content": [
                    "Cuando yo ten√≠a seis a√±os vi una vez un cuadro magn√≠fico en un libro sobre el Bosque Virgen que se llamaba ‚ÄúHistorias vividas‚Äù. Representaba una serpiente boa que se tragaba una fiera. He aqu√≠ la copia del dibujo.",
                    "En el libro se afirmaba: ‚ÄúLas serpientes boa se tragan su presa entera, sin masticarla. Luego no pueden moverse y duermen durante los seis meses de su digesti√≥n.‚Äù",
                    "Reflexion√© mucho en aquel momento sobre las aventuras de la jungla y, a mi vez, logr√© hacer con un l√°piz de color mi primer dibujo. Mi dibujo n√∫mero 1. Era as√≠:",
                    "Les ense√±√© mi obra maestra a las personas mayores y les pregunt√© si mi dibujo les daba miedo. Me respondieron: ‚Äú¬øPor qu√© un sombrero iba a dar miedo?‚Äù",
                    "Mi dibujo no representaba un sombrero. Representaba una serpiente boa que diger√≠a un elefante. Dibuj√© entonces el interior de la serpiente boa para que las personas mayores pudieran comprender. Siempre tienen necesidad de explicaciones."
                ],
                "quiz": [
                    {
                        "question": "¬øQu√© animal representaba el primer dibujo del narrador?",
                        "type": "multiple-choice",
                        "options": ["Un elefante", "Un sombrero", "Una serpiente boa digiriendo un elefante", "Una fiera"],
                        "answer": "Una serpiente boa digiriendo un elefante"
                    },
                    {
                        "question": "¬øCu√°nto tiempo duermen las serpientes boa despu√©s de tragar su presa?",
                        "type": "multiple-choice",
                        "options": ["Un mes", "Tres meses", "Seis meses", "Un a√±o"],
                        "answer": "Seis meses"
                    },
                    {
                        "question": "¬øPor qu√© el narrador dibuj√≥ el interior de la serpiente boa?",
                        "type": "short-answer",
                        "answer": "Para que las personas mayores pudieran comprender"
                    },
                    {
                        "question": "¬øCu√°l es el t√≠tulo del libro que inspir√≥ al narrador?",
                        "type": "multiple-choice",
                        "options": ["Historias de la jungla", "Historias vividas", "Serpientes asombrosas", "El mundo animal"],
                        "answer": "Historias vividas"
                    },
                    {
                        "question": "¬øA qu√© edad el narrador hizo su primer dibujo?",
                        "type": "short-answer",
                        "answer": "Seis a√±os"
                    }
                ]
            },
            {
                "title": "El Patito Feo",
                "author": "Hans Christian Andersen",
                "content": [
                    "En el campo, cerca de un estanque, viv√≠a una pata con sus patitos. Uno de ellos era muy diferente a los dem√°s, era grande, feo y gris.",
                    "Los otros patitos se burlaban de √©l y su propia madre lo ve√≠a con tristeza. El patito feo se sent√≠a solo y abandonado.",
                    "Un d√≠a, decidi√≥ huir del estanque y buscar un lugar donde pudiera ser aceptado. Vag√≥ por muchos lugares, pasando fr√≠o y hambre.",
                    "Cuando lleg√≥ el invierno, el patito feo estuvo a punto de morir de fr√≠o, pero fue rescatado por un campesino que lo llev√≥ a su casa.",
                    "En primavera, el patito volvi√≥ al estanque y vio un grupo de hermosos cisnes. Para su sorpresa, cuando se acerc√≥ a ellos, se dio cuenta de que √©l tambi√©n se hab√≠a convertido en un hermoso cisne."
                ],
                "quiz": [
                    {
                        "question": "¬øC√≥mo era el patito diferente a los dem√°s?",
                        "type": "multiple-choice",
                        "options": ["Peque√±o y blanco", "Grande, feo y gris", "Flaco y marr√≥n", "Lindo y colorido"],
                        "answer": "Grande, feo y gris"
                    },
                    {
                        "question": "¬øQui√©n se burlaba del patito feo?",
                        "type": "multiple-choice",
                        "options": ["Los gansos", "Su madre", "Los otros patitos", "Los campesinos"],
                        "answer": "Los otros patitos"
                    },
                    {
                        "question": "¬øQu√© le sucedi√≥ al patito feo en primavera?",
                        "type": "short-answer",
                        "answer": "Se convirti√≥ en un hermoso cisne"
                    },
                    {
                        "question": "¬øQui√©n rescat√≥ al patito feo en invierno?",
                        "type": "multiple-choice",
                        "options": ["Un cazador", "Una pata", "Un campesino", "Un perro"],
                        "answer": "Un campesino"
                    },
                    {
                        "question": "¬øQu√© sentimiento predominaba en el patito feo al inicio de la historia?",
                        "type": "short-answer",
                        "answer": "Soledad"
                    }
                ]
            }
        ];

        const novelasData = [
            {
                "title": "Don Quijote de la Mancha (Fragmento)",
                "author": "Miguel de Cervantes Saavedra",
                "content": [
                    "En un lugar de la Mancha, de cuyo nombre no quiero acordarme, no ha mucho tiempo que viv√≠a un hidalgo de los de lanza en astillero, adarga antigua, roc√≠n flaco y galgo corredor.",
                    "Una olla de algo m√°s vaca que carnero, salpic√≥n las m√°s noches, duelos y quebrantos los s√°bados, lantejas los viernes, alg√∫n palomino de a√±adidura los domingos, consum√≠an las tres partes de su hacienda.",
                    "El resto della conclu√≠an sayo de velarte, calzas de velludo para las fiestas con sus pantuflos de lo mismo, y los d√≠as de entresemana se honraba con su vellori de lo m√°s fino.",
                    "Ten√≠a en su casa una ama que pasaba de los cuarenta, y una sobrina que no llegaba a los veinte, y un mozo de campo y plaza, que as√≠ ensillaba el roc√≠n como tomaba la podadera.",
                    "Frisaba la edad de nuestro hidalgo con los cincuenta a√±os; era de complexi√≥n recia, seco de carnes, enjuto de rostro, gran madrugador y amigo de la caza. Quieren decir que ten√≠a el sobrenombre de Quijada o Quesada, que en esto hay alguna diferencia en los autores que de este caso escriben; aunque por conjeturas veros√≠miles se deja entender que se llamaba Quijana."
                ],
                "quiz": [
                    {
                        "question": "¬øEn qu√© lugar viv√≠a el hidalgo?",
                        "type": "multiple-choice",
                        "options": ["Andaluc√≠a", "La Mancha", "Extremadura", "Castilla"],
                        "answer": "La Mancha"
                    },
                    {
                        "question": "¬øQu√© edad frisaba el hidalgo?",
                        "type": "multiple-choice",
                        "options": ["Treinta", "Cuarenta", "Cincuenta", "Sesenta"],
                        "answer": "Cincuenta"
                    },
                    {
                        "question": "¬øC√≥mo se llamaba el hidalgo seg√∫n las conjeturas?",
                        "type": "short-answer",
                        "answer": "Quijana"
                    },
                    {
                        "question": "¬øQu√© animal era flaco y ten√≠a el hidalgo?",
                        "type": "multiple-choice",
                        "options": ["Caballo", "Roc√≠n", "Asno", "Mula"],
                        "answer": "Roc√≠n"
                    },
                    {
                        "question": "¬øQu√© comida consum√≠an las m√°s noches?",
                        "type": "short-answer",
                        "answer": "Salpic√≥n"
                    }
                ]
            },
            {
                "title": "Cien A√±os de Soledad (Fragmento)",
                "author": "Gabriel Garc√≠a M√°rquez",
                "content": [
                    "Muchos a√±os despu√©s, frente al pelot√≥n de fusilamiento, el coronel Aureliano Buend√≠a hab√≠a de recordar aquella tarde remota en que su padre lo llev√≥ a conocer el hielo.",
                    "Macondo era entonces una aldea de veinte casas de barro y ca√±abrava construidas a la orilla de un r√≠o de aguas di√°fanas que se precipitaban por un lecho de piedras pulidas, blancas y enormes como huevos prehist√≥ricos.",
                    "El mundo era tan reciente, que muchas cosas carec√≠an de nombre, y para mencionarlas hab√≠a que se√±alarlas con el dedo.",
                    "Todos los a√±os, por el mes de marzo, una familia de gitanos desarrapados plantaba su carpa cerca de la aldea, y con un gran alboroto de pitos y tambores daban a conocer los nuevos inventos.",
                    "Primero llevaron el im√°n. Un gitano corpulento, con barba montaraz y manos de gorri√≥n, que se present√≥ con el nombre de Melqu√≠ades, hizo una p√∫blica demostraci√≥n de lo que √©l llamaba la octava maravilla del mundo."
                ],
                "quiz": [
                    {
                        "question": "¬øQu√© recordaba el coronel Aureliano Buend√≠a frente al pelot√≥n de fusilamiento?",
                        "type": "multiple-choice",
                        "options": ["Su infancia", "El d√≠a que conoci√≥ el hielo", "La guerra", "A su madre"],
                        "answer": "El d√≠a que conoci√≥ el hielo"
                    },
                    {
                        "question": "¬øC√≥mo era Macondo al principio?",
                        "type": "multiple-choice",
                        "options": ["Una ciudad grande", "Un puerto", "Una aldea de veinte casas de barro", "Un campamento militar"],
                        "answer": "Una aldea de veinte casas de barro"
                    },
                    {
                        "question": "¬øQu√© tra√≠an los gitanos a Macondo cada a√±o?",
                        "type": "short-answer",
                        "answer": "Nuevos inventos"
                    },
                    {
                        "question": "¬øQui√©n era Melqu√≠ades?",
                        "type": "multiple-choice",
                        "options": ["El padre del coronel", "Un habitante de Macondo", "Un gitano", "Un soldado"],
                        "answer": "Un gitano"
                    },
                    {
                        "question": "¬øQu√© fue lo primero que llevaron los gitanos?",
                        "type": "short-answer",
                        "answer": "El im√°n"
                    }
                ]
            }
        ];

        const fabulasData = [
            {
                "title": "La Liebre y la Tortuga",
                "author": "Esopo",
                "content": [
                    "Un d√≠a, una liebre se jactaba de su velocidad ante una tortuga, quien, con calma, le propuso una carrera.",
                    "La liebre, confiada en su rapidez, acept√≥ riendo. Al inicio, la liebre corri√≥ muy r√°pido, dejando a la tortuga muy atr√°s.",
                    "Viendo que la tortuga avanzaba muy lentamente, la liebre decidi√≥ tomar una siesta a mitad del camino, segura de que tendr√≠a tiempo de sobra para ganar.",
                    "Mientras la liebre dorm√≠a, la tortuga sigui√≥ avanzando, paso a paso, sin detenerse.",
                    "Cuando la liebre despert√≥, vio con asombro que la tortuga estaba a punto de cruzar la meta. Corri√≥ con todas sus fuerzas, pero ya era demasiado tarde. La tortuga gan√≥ la carrera."
                ],
                "quiz": [
                    {
                        "question": "¬øQui√©n propuso la carrera?",
                        "type": "multiple-choice",
                        "options": ["La liebre", "La tortuga", "Un zorro", "Un p√°jaro"],
                        "answer": "La tortuga"
                    },
                    {
                        "question": "¬øPor qu√© la liebre se detuvo a mitad del camino?",
                        "type": "multiple-choice",
                        "options": ["Estaba cansada", "Quer√≠a esperar a la tortuga", "Decidi√≥ tomar una siesta", "Se perdi√≥"],
                        "answer": "Decidi√≥ tomar una siesta"
                    },
                    {
                        "question": "¬øQu√© hizo la tortuga mientras la liebre dorm√≠a?",
                        "type": "short-answer",
                        "answer": "Sigui√≥ avanzando"
                    },
                    {
                        "question": "¬øCu√°l es la moraleja principal de esta f√°bula?",
                        "type": "multiple-choice",
                        "options": ["La velocidad no importa", "La constancia vence a la rapidez", "Es bueno tomar siestas", "Siempre hay que jactarse"],
                        "answer": "La constancia vence a la rapidez"
                    },
                    {
                        "question": "¬øQu√© animal se jactaba de su velocidad?",
                        "type": "short-answer",
                        "answer": "La liebre"
                    }
                ]
            },
            {
                "title": "El Le√≥n y el Rat√≥n",
                "author": "Esopo",
                "content": [
                    "Un d√≠a, un le√≥n dorm√≠a pl√°cidamente bajo la sombra de un √°rbol. Un peque√±o rat√≥n, sin darse cuenta, pas√≥ corriendo sobre su cara y lo despert√≥.",
                    "El le√≥n, furioso, atrap√≥ al rat√≥n con su pata y estaba a punto de matarlo. El rat√≥n, asustado, le suplic√≥ que lo perdonara, prometiendo que alg√∫n d√≠a le devolver√≠a el favor.",
                    "El le√≥n se ri√≥ de la idea de que un rat√≥n tan peque√±o pudiera ayudar a un rey de la selva, pero, conmovido por su s√∫plica, lo dej√≥ ir.",
                    "Poco tiempo despu√©s, el le√≥n cay√≥ en una trampa de cazadores y qued√≥ atrapado en una red. Rugi√≥ con desesperaci√≥n, pero nadie acudi√≥ en su ayuda.",
                    "El rat√≥n, al escuchar los rugidos, record√≥ su promesa. Corri√≥ hacia el le√≥n y, con sus peque√±os y afilados dientes, roy√≥ las cuerdas de la red hasta liberarlo. El le√≥n aprendi√≥ que incluso los m√°s peque√±os pueden ser de gran ayuda."
                ],
                "quiz": [
                    {
                        "question": "¬øQui√©n despert√≥ al le√≥n?",
                        "type": "multiple-choice",
                        "options": ["Un p√°jaro", "Un rat√≥n", "Un cazador", "Otro le√≥n"],
                        "answer": "Un rat√≥n"
                    },
                    {
                        "question": "¬øQu√© prometi√≥ el rat√≥n al le√≥n?",
                        "type": "multiple-choice",
                        "options": ["Ser su amigo", "Darle comida", "Devolverle el favor", "Nunca volver a molestarlo"],
                        "answer": "Devolverle el favor"
                    },
                    {
                        "question": "¬øC√≥mo ayud√≥ el rat√≥n al le√≥n?",
                        "type": "short-answer",
                        "answer": "Royendo las cuerdas de la red"
                    },
                    {
                        "question": "¬øQu√© lecci√≥n aprendi√≥ el le√≥n?",
                        "type": "multiple-choice",
                        "options": ["Que no debe dormir en el bosque", "Que los ratones son peligrosos", "Que incluso los m√°s peque√±os pueden ser de gran ayuda", "Que debe cazar ratones"],
                        "answer": "Que incluso los m√°s peque√±os pueden ser de gran ayuda"
                    },
                    {
                        "question": "¬øEn qu√© qued√≥ atrapado el le√≥n?",
                        "type": "short-answer",
                        "answer": "En una red"
                    }
                ]
            }
        ];

        const articulosData = [
            {
                "title": "La Importancia de Reciclar",
                "author": "Equipo de Ecolog√≠a Activa",
                "content": [
                    "El reciclaje es un proceso fundamental para la sostenibilidad de nuestro planeta. Consiste en transformar materiales usados en nuevos productos, reduciendo as√≠ la necesidad de consumir recursos naturales frescos.",
                    "Cada a√±o, millones de toneladas de residuos son generadas en todo el mundo. Gran parte de estos residuos terminan en vertederos, contaminando el suelo, el agua y el aire. El reciclaje ayuda a mitigar este problema.",
                    "Adem√°s de la reducci√≥n de la contaminaci√≥n, el reciclaje tambi√©n ahorra energ√≠a. La fabricaci√≥n de productos a partir de materiales reciclados requiere menos energ√≠a que la producci√≥n a partir de materias primas v√≠rgenes.",
                    "Fomentar el reciclaje en nuestras comunidades es vital. Peque√±as acciones como separar la basura en casa y utilizar contenedores espec√≠ficos para cada tipo de residuo, marcan una gran diferencia.",
                    "Educar a las nuevas generaciones sobre la importancia del reciclaje asegura un futuro m√°s limpio y saludable para todos."
                ],
                "quiz": [
                    {
                        "question": "¬øQu√© es el reciclaje?",
                        "type": "multiple-choice",
                        "options": ["Quemar basura", "Transformar materiales usados en nuevos productos", "Tirar todo a la basura", "Enterrar residuos"],
                        "answer": "Transformar materiales usados en nuevos productos"
                    },
                    {
                        "question": "¬øQu√© se reduce al recicrar?",
                        "type": "multiple-choice",
                        "options": ["El consumo de energ√≠a", "La contaminaci√≥n", "El uso de recursos naturales", "Todas las anteriores"],
                        "answer": "Todas las anteriores"
                    },
                    {
                        "question": "¬øQu√© tipo de contaminaci√≥n ayuda a mitigar el reciclaje?",
                        "type": "short-answer",
                        "answer": "Suelo, agua y aire"
                    },
                    {
                        "question": "¬øC√≥mo podemos fomentar el reciclaje en casa?",
                        "type": "multiple-choice",
                        "options": ["Comprando m√°s cosas", "Separando la basura", "Tirando todo al mismo cubo", "No haciendo nada"],
                        "answer": "Separando la basura"
                    },
                    {
                        "question": "¬øQu√© asegura la educaci√≥n sobre el reciclaje a las nuevas generaciones?",
                        "type": "short-answer",
                        "answer": "Un futuro m√°s limpio y saludable"
                    }
                ]
            },
            {
                "title": "El Ciclo del Agua",
                "author": "National Geographic Kids",
                "content": [
                    "El agua en nuestro planeta est√° siempre en movimiento, en un proceso continuo llamado el ciclo del agua. Este ciclo es esencial para la vida en la Tierra.",
                    "Comienza con la evaporaci√≥n, donde el calor del sol convierte el agua de oc√©anos, r√≠os y lagos en vapor de agua, que sube a la atm√≥sfera.",
                    "En la atm√≥sfera, el vapor de agua se enfr√≠a y se convierte en peque√±as gotas de agua o cristales de hielo, formando las nubes. Este proceso se llama condensaci√≥n.",
                    "Cuando las nubes se llenan de agua, esta cae de nuevo a la Tierra en forma de lluvia, nieve o granizo. Esto es la precipitaci√≥n.",
                    "Finalmente, el agua que cae puede ser absorbida por la tierra, fluir hacia r√≠os y lagos, o regresar a los oc√©anos, completando el ciclo y prepar√°ndose para empezar de nuevo."
                ],
                "quiz": [
                    {
                        "question": "¬øC√≥mo se llama el proceso continuo del agua en el planeta?",
                        "type": "multiple-choice",
                        "options": ["El ciclo de vida", "El ciclo del agua", "El ciclo de la energ√≠a", "El ciclo solar"],
                        "answer": "El ciclo del agua"
                    },
                    {
                        "question": "¬øQu√© ocurre durante la evaporaci√≥n?",
                        "type": "multiple-choice",
                        "options": ["El agua se congela", "El agua se convierte en vapor", "El agua cae como lluvia", "El agua se filtra en la tierra"],
                        "answer": "El agua se convierte en vapor"
                    },
                    {
                        "question": "¬øQu√© se forma durante la condensaci√≥n?",
                        "type": "short-answer",
                        "answer": "Nubes"
                    },
                    {
                        "question": "¬øEn qu√© formas puede caer el agua a la Tierra durante la precipitaci√≥n?",
                        "type": "multiple-choice",
                        "options": ["Vapor y niebla", "Lluvia, nieve o granizo", "Hielo y roc√≠o", "Nubes y neblina"],
                        "answer": "Lluvia, nieve o granizo"
                    },
                    {
                        "question": "¬øQu√© es esencial para la vida en la Tierra seg√∫n el texto?",
                        "type": "short-answer",
                        "answer": "El ciclo del agua"
                    }
                ]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const textCategorySelect = document.getElementById('textCategory');
            const textTitle = document.getElementById('textTitle');
            const textAuthor = document.getElementById('textAuthor');
            const textContent = document.getElementById('textContent');
            const readAloudBtn = document.getElementById('readAloudBtn');
            const increaseFontSizeBtn = document.getElementById('increaseFontSizeBtn');
            const decreaseFontSizeBtn = document.getElementById('decreaseFontSizeBtn');
            const toggleThemeBtn = document.getElementById('toggleThemeBtn');
            const startQuizBtn = document.getElementById('startQuizBtn');
            const readingMessage = document.getElementById('readingMessage');
            const quizSection = document.getElementById('quizSection');
            const quizQuestionsContainer = document.getElementById('quizQuestions');
            const submitQuizBtn = document.getElementById('submitQuizBtn');
            const retryQuizBtn = document.getElementById('retryQuizBtn');
            const quizFeedback = document.getElementById('quizFeedback');

            const commentSection = document.getElementById('commentSection');
            const textCommentInput = document.getElementById('textComment');
            const submitCommentBtn = document.getElementById('submitCommentBtn');
            const commentFeedback = document.getElementById('commentFeedback');

            const studentNameInput = document.getElementById('studentName');
            const studentGradeInput = document.getElementById('studentGrade');
            const activateStudentBtn = document.getElementById('activateStudent');
            const studentForm = document.querySelector('.student-form');
            const studentInfo = document.querySelector('.student-info');
            const currentStudentNameSpan = document.getElementById('currentStudentName');
            const currentStudentGradeSpan = document.getElementById('currentStudentGrade');
            const totalScoreSpan = document.getElementById('totalScore');
            const levelAchievedSpan = document.getElementById('levelAchieved');
            const readTextsList = document.getElementById('readTextsList');
            const studentRankingList = document.getElementById('studentRanking');
            const registerNewStudentBtn = document.getElementById('registerNewStudentBtn');


            let currentText = null;
            let currentCategory = 'cuentos';
            let currentQuiz = null;
            let currentFontSize = 1.1; // Rem
            let currentStudent = null;
            let studentScores = JSON.parse(localStorage.getItem('studentScores')) || {};
            let lastDisplayedTextIndexPerCategory = {}; // Para asegurar que se elija un texto diferente

            const loadTexts = async (category) => {
                switch (category) {
                    case 'cuentos':
                        return cuentosData;
                    case 'novelas':
                        return novelasData;
                    case 'fabulas':
                        return fabulasData;
                    case 'articulos':
                        return articulosData;
                    default:
                        return [];
                }
            };

            const displayText = (text) => {
                currentText = text;
                textTitle.textContent = text.title;
                textAuthor.textContent = `Autor: ${text.author}`;
                textContent.innerHTML = text.content.map(p => `<p>${p}</p>`).join('');
                textContent.style.fontSize = `${currentFontSize}rem`;

                readingMessage.style.display = 'none';
                quizSection.style.display = 'none';
                commentSection.style.display = 'none';
                startQuizBtn.style.display = 'block';

                window.speechSynthesis.cancel(); // Detener cualquier s√≠ntesis de voz en curso
                readAloudBtn.textContent = 'üó£Ô∏è Leer en Voz Alta'; // Resetear texto del bot√≥n de lectura
            };

            const selectRandomText = async () => {
                const texts = await loadTexts(currentCategory);
                if (texts.length > 0) {
                    let newIndex;
                    const lastIndex = lastDisplayedTextIndexPerCategory[currentCategory];

                    if (texts.length > 1) {
                        do {
                            newIndex = Math.floor(Math.random() * texts.length);
                        } while (newIndex === lastIndex); // Asegura un √≠ndice diferente si hay m√°s de un texto
                    } else {
                        newIndex = 0; // Si solo hay un texto, siempre ser√° el mismo
                    }

                    lastDisplayedTextIndexPerCategory[currentCategory] = newIndex;
                    console.log(`Categor√≠a: ${currentCategory}, Texto seleccionado: ${texts[newIndex].title}`);
                    displayText(texts[newIndex]);
                } else {
                    textTitle.textContent = '';
                    textAuthor.textContent = '';
                    textContent.innerHTML = `<p class="placeholder-text">No hay textos disponibles en esta categor√≠a.</p>`;
                    startQuizBtn.style.display = 'none';
                }
            };

            // --- Funcionalidad de Voz (speechSynthesis) ---
            let currentUtterance = null; // Variable para mantener la referencia a la s√≠ntesis de voz

            readAloudBtn.addEventListener('click', () => {
                if (!('speechSynthesis' in window) || !currentText) {
                    console.error('Tu navegador no soporta la lectura en voz alta o no hay texto seleccionado.');
                    return;
                }

                if (window.speechSynthesis.speaking) {
                    // Si est√° hablando (o pausado), cancela la lectura
                    window.speechSynthesis.cancel();
                    readAloudBtn.textContent = 'üó£Ô∏è Leer en Voz Alta'; // Vuelve al estado inicial
                    console.log('Lectura detenida.');
                } else {
                    // Si no est√° hablando, inicia una nueva lectura
                    currentUtterance = new SpeechSynthesisUtterance(currentText.content.join(' '));
                    currentUtterance.lang = 'es-ES';
                    window.speechSynthesis.speak(currentUtterance);
                    readAloudBtn.textContent = 'üõë Detener Lectura'; // Cambia el texto para indicar que se puede detener
                    console.log('Iniciando nueva lectura.');

                    currentUtterance.onend = () => {
                        readAloudBtn.textContent = 'üó£Ô∏è Leer en Voz Alta'; // Vuelve al estado inicial al finalizar
                        currentUtterance = null;
                        console.log('Lectura finalizada.');
                    };
                }
            });

            // --- Cambio de tama√±o de texto ---
            increaseFontSizeBtn.addEventListener('click', () => {
                currentFontSize = Math.min(currentFontSize + 0.1, 2.0); // L√≠mite superior
                textContent.style.fontSize = `${currentFontSize}rem`;
            });

            decreaseFontSizeBtn.addEventListener('click', () => {
                currentFontSize = Math.max(currentFontSize - 0.1, 0.8); // L√≠mite inferior
                textContent.style.fontSize = `${currentFontSize}rem`;
            });

            // --- Modo Claro/Oscuro ---
            toggleThemeBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDarkMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            });

            // Cargar preferencia de tema al iniciar
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            // --- Registro y Seguimiento de Estudiantes ---
            const saveStudentScores = () => {
                localStorage.setItem('studentScores', JSON.stringify(studentScores));
            };

            const updateStudentUI = () => {
                // studentForm is always visible
                // studentInfo is always visible
                if (currentStudent) {
                    currentStudentNameSpan.textContent = currentStudent.name;
                    currentStudentGradeSpan.textContent = currentStudent.grade;
                    totalScoreSpan.textContent = currentStudent.totalScore;
                    updateLevel(currentStudent.totalScore);
                    // Hide the student input form when a student is active
                    studentForm.style.display = 'none';
                    studentInfo.style.display = 'block';
                } else {
                    studentNameInput.value = ''; // Limpiar campos al no haber estudiante activo
                    studentGradeInput.value = '';
                    currentStudentNameSpan.textContent = 'Ninguno'; // Placeholder
                    currentStudentGradeSpan.textContent = 'N/A'; // Placeholder
                    totalScoreSpan.textContent = '0';
                    levelAchievedSpan.textContent = 'N/A';
                    levelAchievedSpan.className = ''; // Limpiar clases de nivel
                    // Show the student input form when no student is active
                    studentForm.style.display = 'block';
                    studentInfo.style.display = 'none'; // Hide student info when no student is active
                }
                renderReadTexts();
                renderRanking();
            };

            const updateLevel = (score) => {
                let level = '';
                let levelClass = '';
                if (score >= 400) {
                    level = 'Logro Destacado (AD)';
                    levelClass = 'level-ad'; // Verde
                } else if (score >= 250) {
                    level = 'Logrado (A)';
                    levelClass = 'level-a'; // Anaranjado
                } else if (score >= 100) {
                    level = 'Proceso (B)';
                    levelClass = 'level-b'; // Amarillo
                } else {
                    level = 'Inicio (C)';
                    levelClass = 'level-c'; // Rojo
                }
                levelAchievedSpan.textContent = level;
                levelAchievedSpan.className = '';
                levelAchievedSpan.classList.add(levelClass);
            };

            const renderReadTexts = () => {
                readTextsList.innerHTML = '';
                if (currentStudent && currentStudent.readTexts) {
                    currentStudent.readTexts.forEach(text => {
                        const li = document.createElement('li');
                        li.textContent = text;
                        readTextsList.appendChild(li);
                    });
                }
            };

            const renderRanking = () => {
                studentRankingList.innerHTML = '';
                const sortedStudents = Object.values(studentScores).sort((a, b) => b.totalScore - a.totalScore);
                sortedStudents.forEach((student, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. ${student.name} (${student.grade}) - ${student.totalScore} pts`;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-student-btn');
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.title = `Eliminar a ${student.name}`;
                    deleteBtn.dataset.studentKey = student.name.toLowerCase().replace(/\s/g, '-'); // Usar la clave para identificar
                    li.appendChild(deleteBtn);

                    studentRankingList.appendChild(li);
                });
            };

            // Funci√≥n para eliminar estudiante
            const deleteStudent = (studentKeyToDelete) => {
                if (confirm(`¬øEst√°s seguro de que quieres eliminar el registro de este estudiante?`)) { // Usar confirm para simplicidad, idealmente un modal
                    delete studentScores[studentKeyToDelete];
                    saveStudentScores();
                    if (currentStudent && currentStudent.name.toLowerCase().replace(/\s/g, '-') === studentKeyToDelete) {
                        currentStudent = null; // Si se elimina el estudiante activo, se desactiva
                    }
                    updateStudentUI();
                    console.log(`Estudiante con clave ${studentKeyToDelete} eliminado.`);
                }
            };

            // Delegaci√≥n de eventos para los botones de eliminar
            studentRankingList.addEventListener('click', (event) => {
                if (event.target.classList.contains('delete-student-btn')) {
                    const studentKeyToDelete = event.target.dataset.studentKey;
                    deleteStudent(studentKeyToDelete);
                }
            });


            activateStudentBtn.addEventListener('click', () => {
                const name = studentNameInput.value.trim();
                const grade = studentGradeInput.value.trim();

                if (name && grade) {
                    const studentKey = name.toLowerCase().replace(/\s/g, '-');
                    if (!studentScores[studentKey]) {
                        studentScores[studentKey] = {
                            name: name,
                            grade: grade,
                            totalScore: 0,
                            readTexts: []
                        };
                    }
                    currentStudent = studentScores[studentKey];
                    localStorage.setItem('lastActiveStudent', studentKey);
                    saveStudentScores();
                    updateStudentUI();
                    console.log(`¬°Bienvenido(a), ${name} de ${grade}!`);
                } else {
                    console.error('Por favor, ingresa tu nombre completo y grado para activar el seguimiento.');
                }
            });

            registerNewStudentBtn.addEventListener('click', () => {
                currentStudent = null;
                localStorage.removeItem('lastActiveStudent');
                updateStudentUI(); // Esto har√° visible el formulario y limpiar√° los campos
                console.log('Preparado para registrar un nuevo estudiante.');
            });


            const lastActiveStudentName = localStorage.getItem('lastActiveStudent');
            if (lastActiveStudentName && studentScores[lastActiveStudentName]) {
                currentStudent = studentScores[lastActiveStudentName];
                updateStudentUI();
            } else {
                updateStudentUI(); // Asegurarse de que el formulario est√© visible si no hay estudiante activo
            }

            // --- Quiz de Comprensi√≥n ---
            startQuizBtn.addEventListener('click', () => {
                if (!currentText || !currentText.quiz || currentText.quiz.length === 0) {
                    console.warn('Este texto no tiene preguntas de comprensi√≥n asociadas.');
                    return;
                }
                readingMessage.style.display = 'block';
                setTimeout(() => {
                    quizSection.style.display = 'block';
                    readingMessage.style.display = 'none';
                    startQuizBtn.style.display = 'none';
                    generateQuiz(currentText.quiz);
                }, 1500);
            });

            const generateQuiz = (quiz) => {
                currentQuiz = quiz;
                quizQuestionsContainer.innerHTML = '';
                quizFeedback.textContent = '';
                submitQuizBtn.style.display = 'block';
                retryQuizBtn.style.display = 'none';

                quiz.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question');
                    questionDiv.innerHTML = `<p>${index + 1}. ${q.question}</p>`;

                    if (q.type === 'multiple-choice') {
                        q.options.forEach((option, optionIndex) => {
                            questionDiv.innerHTML += `
                                <label>
                                    <input type="radio" name="question${index}" value="${option}">
                                    ${option}
                                </label>
                            `;
                        });
                    } else if (q.type === 'short-answer') {
                        const inputId = `quizQuestion${index}`; // ID √∫nico para el input
                        questionDiv.innerHTML += `
                            <div class="input-with-speech">
                                <input type="text" id="${inputId}" name="question${index}" class="short-answer-input" placeholder="Escribe tu respuesta aqu√≠">
                                <button class="speech-input-btn" data-target="${inputId}" title="Dictar respuesta">üé§</button>
                            </div>
                        `;
                    }
                    quizQuestionsContainer.appendChild(questionDiv);
                });
            };

            submitQuizBtn.addEventListener('click', () => {
                let correctAnswers = 0;
                let totalQuestions = currentQuiz.length;

                currentQuiz.forEach((q, index) => {
                    const questionDiv = quizQuestionsContainer.children[index];
                    let isCorrect = false;

                    if (q.type === 'multiple-choice') {
                        const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                        if (selectedOption && selectedOption.value === q.answer) {
                            isCorrect = true;
                        }
                        document.querySelectorAll(`input[name="question${index}"]`).forEach(input => input.disabled = true);
                    } else if (q.type === 'short-answer') {
                        const input = document.querySelector(`input[name="question${index}"]`);
                        if (input && input.value.trim().toLowerCase() === q.answer.toLowerCase()) {
                            isCorrect = true;
                        }
                        input.disabled = true;
                        // Tambi√©n deshabilitar el bot√≥n de dictado de voz asociado
                        const speechButton = input.nextElementSibling;
                        if (speechButton && speechButton.classList.contains('speech-input-btn')) {
                            speechButton.disabled = true;
                        }
                    }

                    if (isCorrect) {
                        correctAnswers++;
                        let feedbackSpan = questionDiv.querySelector('.feedback-span');
                        if (!feedbackSpan) {
                            feedbackSpan = document.createElement('span');
                            feedbackSpan.classList.add('feedback-span');
                            questionDiv.appendChild(feedbackSpan);
                        }
                        feedbackSpan.style.marginLeft = '10px';
                        feedbackSpan.style.fontWeight = 'bold';
                        feedbackSpan.style.color = 'green';
                        feedbackSpan.textContent = '‚úîÔ∏è Correcto';
                    } else {
                        let feedbackSpan = questionDiv.querySelector('.feedback-span');
                        if (!feedbackSpan) {
                            feedbackSpan = document.createElement('span');
                            feedbackSpan.classList.add('feedback-span');
                            questionDiv.appendChild(feedbackSpan);
                        }
                        feedbackSpan.style.marginLeft = '10px';
                        feedbackSpan.style.fontWeight = 'bold';
                        feedbackSpan.style.color = 'red';
                        feedbackSpan.textContent = `‚ùå Incorrecto (Correcta: ${q.answer})`;
                    }
                });

                const score = correctAnswers * 10;
                quizFeedback.textContent = `Has acertado ${correctAnswers} de ${totalQuestions} preguntas. Tu puntaje en el quiz es: ${score} puntos.`;

                if (currentStudent) {
                    currentStudent.totalScore += score;
                    if (!currentStudent.readTexts.includes(currentText.title)) {
                        currentStudent.readTexts.push(currentText.title);
                    }
                    saveStudentScores();
                    updateStudentUI();
                }

                submitQuizBtn.style.display = 'none';
                retryQuizBtn.style.display = 'block';

                setTimeout(() => {
                    quizSection.style.display = 'none';
                    commentSection.style.display = 'block';
                    textCommentInput.value = '';
                    commentFeedback.textContent = '';
                    textCommentInput.disabled = false;
                    submitCommentBtn.disabled = false;
                }, 2000);
            });

            retryQuizBtn.addEventListener('click', () => {
                generateQuiz(currentQuiz);
            });

            // --- Secci√≥n de Comentarios ---
            submitCommentBtn.addEventListener('click', () => {
                const comment = textCommentInput.value.trim();
                if (comment) {
                    console.log(`Comentario del estudiante sobre "${currentText.title}":\n${comment}`);
                    commentFeedback.style.color = 'green';
                    commentFeedback.textContent = '¬°Gracias por tu comentario! Ha sido registrado.';
                    textCommentInput.disabled = true;
                    submitCommentBtn.disabled = true;
                    // Tambi√©n deshabilitar el bot√≥n de dictado de voz asociado
                    const speechButton = textCommentInput.nextElementSibling;
                    if (speechButton && speechButton.classList.contains('speech-input-btn')) {
                        speechButton.disabled = true;
                    }
                } else {
                    commentFeedback.style.color = 'red';
                    commentFeedback.textContent = 'Por favor, escribe un comentario antes de enviar.';
                }
            });

            // --- Inicializaci√≥n de Dictado de Voz ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const speechRecognitionSupported = SpeechRecognition !== undefined;

            if (!speechRecognitionSupported) {
                console.warn('El reconocimiento de voz no es compatible con este navegador.');
                // Deshabilitar los botones de voz si no hay soporte
                document.querySelectorAll('.speech-input-btn').forEach(btn => btn.disabled = true);
            }

            // Delegaci√≥n de eventos para los botones de dictado de voz (incluyendo los generados din√°micamente)
            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('speech-input-btn')) {
                    const button = event.target;
                    if (!speechRecognitionSupported) {
                        alert('El reconocimiento de voz no es compatible con tu navegador. Por favor, actualiza o usa otro navegador.');
                        return;
                    }

                    const targetId = button.dataset.target;
                    const targetInput = document.getElementById(targetId);

                    const recognition = new SpeechRecognition();
                    recognition.continuous = false; // Para entradas cortas, no continua
                    recognition.interimResults = false; // Solo resultados finales
                    recognition.lang = 'es-ES'; // Idioma espa√±ol

                    let isRecognizing = false;

                    recognition.onstart = () => {
                        isRecognizing = true;
                        button.textContent = 'üî¥ Grabando...';
                        button.disabled = true; // Deshabilitar bot√≥n mientras graba
                        console.log('Reconocimiento de voz iniciado.');
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        targetInput.value = transcript; // Sobrescribir el valor del input
                        console.log('Resultado del reconocimiento:', transcript);
                    };

                    recognition.onerror = (event) => {
                        console.error('Error de reconocimiento de voz:', event.error);
                        button.textContent = 'üé§'; // Resetear texto del bot√≥n
                        button.disabled = false; // Volver a habilitar el bot√≥n
                        isRecognizing = false;
                        alert(`Error en el reconocimiento de voz: ${event.error}. Aseg√∫rate de que tu micr√≥fono est√© conectado y permitas el acceso.`);
                    };

                    recognition.onend = () => {
                        isRecognizing = false;
                        button.textContent = 'üé§'; // Resetear texto del bot√≥n
                        button.disabled = false; // Volver a habilitar el bot√≥n
                        console.log('Reconocimiento de voz finalizado.');
                    };

                    // Iniciar reconocimiento
                    recognition.start();
                }
            });

            // Inicializaci√≥n al cargar la p√°gina
            selectRandomText();

            // Event listener para el cambio de categor√≠a
            textCategorySelect.addEventListener('change', () => {
                currentCategory = textCategorySelect.value;
                selectRandomText(); // Llama a la funci√≥n para seleccionar un nuevo texto
            });
        });
    </script>
</body>
</html>



